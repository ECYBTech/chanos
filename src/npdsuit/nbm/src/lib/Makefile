# Network Platform Daemon Board Management Library
#

APP_TARGET_NAME = nbm

CC  = $(COMPILER_PREFIX)gcc

CFLAGS += -fPIC -Wall $(INCLUDE_AUTEWARE_MODULES)

ifeq ($(DRV_LIB_FLAG),CPSS) 
CFLAGS += -DDRV_LIB_CPSS
endif

ifeq ($(DRV_LIB_FLAG),CPSS_XCAT)
CFLAGS += -DDRV_LIB_CPSS -DDRV_LIB_CPSS_XCAT -DDIAG_XCAT
endif

ifeq ($(DRV_LIB_FLAG),BCM)
CFLAGS += -DDRV_LIB_BCM -DBCM_ESW_SUPPORT
endif

ifeq ($(DRV_LIB_FLAG), ATHEROS)
CFLAGS += -DDRV_LIB_ATHEROS -fPIC
endif

LDFLAGS = -g -shared -Wl,-soname,$(NPD_BM_SHLIB_SONAME)



INCLUDES += -I$(ACCAPI_DIR) -I$(ACCAPI_DIR)/npd -I$(ACCAPI_DIR)/nbm  
INCLUDES += -I$(USER_ADDITION_LIB_ROOT_PATH)/include
LIBS += $(DBUS_LIBS)
INCLUDES += $(DBUS_INCLUDE) 

DBUS_LIBS = -ldbus-1
LIBS += $(DBUS_LIBS)

NPD_BM_OBJS = nbm_util.o nbm_cpld.o nbm_eeprom.o nbm_log.o

NPD_BM_SHLIB_MAJOR = 0
NPD_BM_SHLIB_MINOR = 1


NPD_BM_SHLIB_LINKERNAME = libnbm.so
NPD_BM_SHLIB_SONAME = $(NPD_BM_SHLIB_LINKERNAME).$(NPD_BM_SHLIB_MAJOR)
NPD_BM_SHLIB_REALNAME = $(NPD_BM_SHLIB_SONAME).$(NPD_BM_SHLIB_MINOR)

BUILD_TARGET_OBJS += $(foreach module,$(NPD_BM_OBJS), $(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/$(module))

.PHONY: all
all: $(NPD_BM_SHLIB_REALNAME) 

$(NPD_BM_SHLIB_REALNAME): $(BUILD_TARGET_OBJS)
	$(CC) $(LDFLAGS) -o $@ $^
	rm -rf $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_REALNAME) $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_SONAME) $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_LINKERNAME)
	cp $(NPD_BM_SHLIB_REALNAME) $(LIB_EXPORT_DIR)/
	ln -s $(NPD_BM_SHLIB_REALNAME)  $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_SONAME)
	ln -s $(NPD_BM_SHLIB_SONAME)  $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_LINKERNAME)


$(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/%.o: %.c
	$(CC) -c $(CFLAGS) $(DBUS_INCLUDE) $(INCLUDES) -o $@ $<


.PHONY: clean
clean:
	rm -rf *~ *.o $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_REALNAME)  $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_SONAME)  $(LIB_EXPORT_DIR)/$(NPD_BM_SHLIB_LINKERNAME) $(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/* $(NPD_BM_SHLIB_REALNAME)

