# Network Platform Daemon 
#

APP_TARGET_NAME = npd

CC  = $(COMPILER_PREFIX)gcc

CFLAGS = -g -Wall -D_GNU_SOURCE -D__USE_UNIX98 -D__USE_GNU $(INCLUDE_CHANOS_MODULES)#-ansi
INCLUDES += -I$(USER_ADDITION_LIB_ROOT_PATH)/include
INCLUDES += -I$(ACCAPI_DIR) -I$(ACCAPI_DIR)/npd -I$(ACCAPI_DIR)/lib -I$(ACCAPI_DIR)/nam


ifeq ($(DRV_LIB_FLAG),CPSS_LION2)
INCLUDES += -I$(SDK_TOPDIR)/mainPpDrv/h
INCLUDES += -I$(SDK_TOPDIR)/common/h
INCLUDES += -I$(SDK_TOPDIR)/cpssEnabler/mainOs/h
CFLAGS += -DINCLUDE_L3 -DDRV_LIB_CPSS -DDRV_LIB_CPSS_LION2
endif

NPD_CHASM_SPEC_OBJS = ds_product_common_init.o ds_product_common_info.o  \
		      ds_product_info.o ds_marvell_spec_init.o
INCLUDES += -I$(USER_ADDITION_LIB_ROOT_PATH)/include


#ifeq ($(DRV_LIB_FLAG), CPSS_LION2)
#NPD_CHASM_SPEC_OBJS += ds_marvell_spec_init.o
#endif


NPD_CHASM_SPEC_DEPFILES = ds.dep

DC_LIST := $(patsubst %.o,%.dc,$(NPD_CHASM_SPEC_OBJS))

BUILD_CHASM_OBJS += $(foreach module,$(NPD_CHASM_SPEC_OBJS), $(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/$(module))

LDFLAGS = -g -shared -Wl,-soname,$(NPD_CHASM_INIT_SHLIB_SONAME)

NPD_CHASM_INIT_SHLIB_MAJOR = 0
NPD_CHASM_INIT_SHLIB_MINOR = 1

NPD_CHASM_INIT_SHLIB_LINKERNAME = libpdt_init.so
NPD_CHASM_INIT_SHLIB_SONAME = $(NPD_CHASM_INIT_SHLIB_LINKERNAME).$(NPD_CHASM_INIT_SHLIB_MAJOR)
NPD_CHASM_INIT_SHLIB_REALNAME = $(NPD_CHASM_INIT_SHLIB_SONAME).$(NPD_CHASM_INIT_SHLIB_MINOR)

.PHONY: all

all: $(NPD_CHASM_INIT_SHLIB_REALNAME)
$(NPD_CHASM_INIT_SHLIB_REALNAME): $(BUILD_CHASM_OBJS)
	$(CC) $(LDFLAGS) -o $@ $^
	rm -rf $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_REALNAME) $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_SONAME) $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_LINKERNAME)
	cp $(NPD_CHASM_INIT_SHLIB_REALNAME) $(LIB_EXPORT_DIR)/
	cp $(NPD_CHASM_INIT_SHLIB_REALNAME) $(BUILD_ROOTFS_DIR)/opt/lib/
	ln -s $(NPD_CHASM_INIT_SHLIB_REALNAME) $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_SONAME)
	ln -s $(NPD_CHASM_INIT_SHLIB_SONAME) $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_LINKERNAME)
	cp $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_REALNAME) $(BUILD_ROOTFS_DIR)/opt/lib
	cp $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_SONAME) $(BUILD_ROOTFS_DIR)/opt/lib
	cp $(LIB_EXPORT_DIR)/$(NPD_CHASM_INIT_SHLIB_LINKERNAME) $(BUILD_ROOTFS_DIR)/opt/lib
	
$(BUILD_CHASM_OBJS): $(NPD_CHASM_SPEC_DEPFILES) 

dep: $(DC_LIST)
	@echo building file dependency done...
cleandep:
	rm -rf $(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/$(NPD_CHASM_SPEC_DEPFILES)
	
$(NPD_CHASM_SPEC_DEPFILES):cleandep dep

include $(NPD_CHASM_SPEC_DEPFILES)

$(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/%.o: %.c
	$(CC) -c $(CFLAGS) $(DBUS_INCLUDE) $(INCLUDES) $(DBUS_INCLUDE) -o $@ $<

$(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/%.o: %.c
	$(CC) -c $(CFLAGS) $(INCLUDES) $(DBUS_INCLUDE) -o $@ $<

%.dc: %.c
	$(CC) $(CFLAGS) $(DBUS_INCLUDE) $(INCLUDES) -MM $< >>  $(NPD_CHASM_SPEC_DEPFILES)
		
.PHONY: clean
clean:
	rm -f $(PROJECT_BUILD_DIR)/$(APP_TARGET_NAME)/*
	rm -f $(NPD_CHASM_INIT_SHLIB_SONAME) $(NPD_CHASM_INIT_SHLIB_REALNAME) $(NPD_CHASM_INIT_SHLIB_REALNAME) 
	
